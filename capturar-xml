from flask import Flask, request
import logging

app = Flask(__name__)

# Configuração do logger para exibir logs no console
logging.basicConfig(level=logging.DEBUG)

@app.route("/capturar_xml", methods=["POST"])
def capturar_xml():
    try:
        content_type = request.headers.get("Content-Type", "").lower()
        logging.debug(f"Tipo de conteúdo recebido: {content_type}")
        
        xml_data = None

        # Tenta capturar o XML de várias formas
        if request.form:
            for possible_name in ["TextXML", "textxml", "xmldata", "xml"]:
                if possible_name in request.form:
                    xml_data = request.form.get(possible_name)
                    logging.debug(f"XML encontrado no campo {possible_name}")
                    break
            
            if not xml_data and len(request.form) > 0:
                first_key = next(iter(request.form))
                xml_data = request.form.get(first_key)
                logging.debug(f"Usando primeiro campo do form: {first_key}")

        if not xml_data and request.data:
            try:
                xml_data = request.data.decode("utf-8")
                logging.debug("Usando dados brutos do corpo da requisição")
            except:
                pass
        
        if not xml_data:
            return "Erro: Nenhum XML encontrado na requisição", 400

        # Loga o XML completo
        logging.debug(f"\n===== XML RECEBIDO =====\n{xml_data}\n========================")  

        return "XML capturado com sucesso", 200

    except Exception as e:
        logging.error(f"Erro ao capturar XML: {str(e)}")
        return "Erro ao processar XML", 500

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
