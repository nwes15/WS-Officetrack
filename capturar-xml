from flask import Flask, request, Response
import logging

app = Flask(__name__)

# Configuração do logger
logging.basicConfig(level=logging.DEBUG)

@app.route("/customer_web_service", methods=["POST"])
def customer_web_service():
    try:
        # Log do tipo de conteúdo recebido
        content_type = request.headers.get("Content-Type", "").lower()
        logging.debug(f"Tipo de conteúdo recebido: {content_type}")

        # Tenta extrair o XML do request.form
        xml_data = None
        for possible_name in ["TextXML", "textxml", "xmldata", "xml"]:
            if possible_name in request.form:
                xml_data = request.form.get(possible_name)
                logging.debug(f"XML encontrado no campo {possible_name}")
                break

        # Se não encontrou por nome específico, tenta o primeiro campo do form
        if not xml_data and len(request.form) > 0:
            first_key = next(iter(request.form))
            xml_data = request.form.get(first_key)
            logging.debug(f"Usando primeiro campo do form: {first_key}")

        # Verifica se o XML foi encontrado
        if not xml_data:
            logging.error("Erro: Nenhum dado XML foi encontrado no formulário.")
            return Response(
                "<Erro>Nenhum dado XML foi encontrado no formulário.</Erro>",
                content_type="application/xml",
                status=400
            )

        # Log do XML recebido
        logging.debug(f"XML recebido: {xml_data}")

        # Retorna o XML recebido como resposta
        return Response(xml_data, content_type="application/xml")

    except Exception as e:
        # Log do erro completo, incluindo a stack trace
        logging.error("Erro durante o processamento da requisição:", exc_info=True)
        return Response(
            f"<Erro>Erro interno no servidor: {str(e)}</Erro>",
            content_type="application/xml",
            status=500
        )

if __name__ == "__main__":
    app.run(debug=True)
