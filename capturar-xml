from flask import Flask, request, Response
import logging
from lxml import etree

app = Flask(__name__)

# Configuração do logger
logging.basicConfig(level=logging.DEBUG)

@app.route("/capturar_xml", methods=["POST"])
def capturar_xml():
    try:
        content_type = request.headers.get("Content-Type", "").lower()
        logging.debug(f"Tipo de conteúdo recebido: {content_type}")
        
        xml_data = None
        
        # Tenta extrair o XML do formulário
        if request.form:
            for possible_name in ["TextXML", "textxml", "xmldata", "xml"]:
                if possible_name in request.form:
                    xml_data = request.form.get(possible_name)
                    logging.debug(f"XML encontrado no campo {possible_name}")
                    break
            
            if not xml_data and len(request.form) > 0:
                first_key = next(iter(request.form))
                xml_data = request.form.get(first_key)
                logging.debug(f"Usando primeiro campo do form: {first_key}")
        
        # Se não encontrou no form, tenta do corpo da requisição
        if not xml_data and request.data:
            try:
                xml_data = request.data.decode('utf-8')
                logging.debug("Usando dados brutos do corpo da requisição")
            except:
                pass
        
        if xml_data:
            logging.debug(f"XML recebido: {xml_data}")
            
            # Retorna a resposta XML fixa
            return gerar_resposta_xml()
        else:
            return "Nenhum XML encontrado na requisição.", 400

    except Exception as e:
        logging.error(f"Erro interno: {str(e)}")
        return f"Erro interno no servidor: {str(e)}", 500

def gerar_resposta_xml():
    """Gera a resposta XML fixa para o aplicativo."""
    xml_response = """
    <Response>
        <Message>
            <Text>Invalid data</Text>
            <Icon>Warning/Critical/Info</Icon>
            <ButtonText>OK</ButtonText>
        </Message>
        <ReturnValue>
            <ShortText>XML CAPTURADO</ShortText>
            <LongText>Seu XML está disponível nas logs</LongText>
            <Value>OK</Value>
            <Action>SendEntry</Action>
        </ReturnValue>
    </Response>
    """
    return Response(xml_response, content_type="application/xml")

# Remova a linha app.run() para o Render
